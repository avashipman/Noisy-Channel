<!DOCTYPE html>
<html>

<head>
  <title>Alternate</title>
  <script src="jspsych-6.1.0/jspsych.js"></script>
  <script src="jspsych-6.1.0/plugins/jspsych-html-keyboard-response.js"></script>
  <script src="jspsych-6.1.0/plugins/jspsych-survey-text-edit.js"></script>
  <script src="jspsych-6.1.0/plugins/jspsych-html-button-response.js"></script>
  <script src="jspsych-6.1.0/plugins/jspsych-image-keyboard-response.js"></script>
  <script src="jspsych-6.1.0/jspsych-survey-distractor-copy.js"></script>
  <link href="jspsych-6.1.0/css/jspsych.css" rel="stylesheet" type="text/css">
  <link href="jspsych-6.1.0/css/fadeOut.css" rel="stylesheet" type="text/css">
  <style>
    .center {
      display: block;
      margin-left: auto;
      margin-right: auto;
      width: 50%;
    }
  </style>
</head>

<body>
  <script>

    var timeline = [];
    /* define welcome message trial */
    var welcome = {
      type: "html-keyboard-response",
      stimulus: "Welcome to the experiment. Press any key to begin."
    };
    timeline.push(welcome);

    /* define instructions trial */
    var instructions1 = {
      type: "html-button-response",
      stimulus: "<div style='text-align:left;'><p>In this task, we will ask you a variety of questions about your impressions, activities, beliefs, preferences, etc. " +
        "We would like you to answer each of these questions with one full sentence, which can be as long as you want. </p>" +
        "<p>For any question, if you can't think of an answer from your experiences (or prefer not to), please respond with what you imagine a friend or acquaintance might respond. " +
        "<strong> Just type what comes to mind. </strong>"+
        "Do not worry about making errors while typing; the backspace will be disabled. " +
        "We will give you a chance afterwards to correct any errors you find in your response. </p></d>" +
        "<br></br>",
      choices: ["NEXT"],
      post_trial_gap: 500
    };
    timeline.push(instructions1);

    var instructions2 = {
      type: "html-button-response",
      stimulus: "<p>While you are completing your sentence, there will be geometric shapes appearing at the bottom of the screen. " +
        "<p>If you see a <strong> Red X </strong>, press 8. Otherwise, please refrain from responding to any other shapes.</p>" +
        "<br></br>" +
        "<div class='center'><img src='target.png'></img>" +
        "<p class='small'><strong>Press 8</strong></p></div>" +
        "</div>" + "<br></br>",
      choices: ["CONTINUE TO A PRACTICE TRIAL"],
      post_trial_gap: 500
    };
    timeline.push(instructions2);

    //load stimuli (images and timeline variables)
    var images = [
      'addition.png',
      'blacksquareJ.png',
      'diamond.png',
      'hexagon.png',
      'orangeimgJ.png',
      'pentagonJ.png',
      'rectangle.png',
      'star.png',
      'triangleJ.png',
      'target.png'
    ];
    var testVariables = [
      { prompt: 'Describe the restaurant you are least likely to recommend to a friend.', distractor: jsPsych.randomization.sampleWithReplacement(images, 50, [1, 5, 1, 1, 1, 1, 1, 1, 1, 7]) },
      { prompt: 'Does your state have the death penalty and do you think it should?', distractor: jsPsych.randomization.sampleWithReplacement(images, 50, [1, 5, 1, 1, 1, 1, 1, 1, 1, 7]) },
      ];
    var trial_counter = 0;

    //practice trial
      var practice = {
        timeline: [
          {
            type: "survey-distractor",
            questions: [{ prompt: "This is what the task will look like. Press 8 when the red X appears." }],
            button_label: "SUBMIT",
            preamble: "Please write one sentence.",
            stimulus: jsPsych.randomization.sampleWithReplacement(images, 50, [1.5, 14, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 24]),
            choices: [56],
            response_next_image: 1800,
            post_trial_gap: 500,
          },

          {
            type: "survey-text-edit",
            questions: function () {
              const prev_answer = JSON.parse(
                jsPsych.data.getLastTrialData().values()[0].responses
              ).Q0;
              var new_prompt = "<p>Please edit your sentence or copy it.</p>";
              new_prompt += "<p>'" + prev_answer + "'</p>";

              return [{ prompt: new_prompt }];
            },
            post_trial_gap: 1000,
          }
        ],
      };
      timeline.push(practice);

    //start the experiment
    var start = {
      type: "html-button-response",
      stimulus: "<p>Good practice!</p> <p>Press the button when you are ready to start the experiment.</p> <br></br>",
      choices: ["BEGIN"],
      post_trial_gap: 1000
    };
    timeline.push(start);

    //experiment
    var experiment = {
      timeline: [
        {
          type: "survey-distractor",
          questions: function () {
            return [{ prompt: jsPsych.timelineVariable("prompt", true) }];
          },
          stimulus: jsPsych.timelineVariable("distractor"),
          choices: [56],
          preamble: "Please write one sentence.",
          response_next_image: 1800,
          post_trial_gap: 500,
        },

        {
          type: "survey-text-edit",
          questions: function () {
            const prev_answer = JSON.parse(
              jsPsych.data.getLastTrialData().values()[0].responses
            ).Q0;
            var new_prompt = "<p>Please edit your sentence or copy it.</p>";
            new_prompt += "<p>'" + prev_answer + "'</p>";

            return [{ prompt: new_prompt }];
          },
          post_trial_gap: 1000,
        }
      ],
    };

    
    //rest timeline
    var rest = {
      type: "html-button-response",
      stimulus: function () {
          var lastData = jsPsych.data.get().last(4);
          var words = lastData.select('responses').values.toString();
          var wordCount = words.split(" ").length;

          var targetAmount = lastData.select('target').sum();
          var correctAmount = lastData.select('correctKeyPressed').values.toString();
          var correct_amount = (correctAmount.match(/56/g) || []).length
          console.log(correct_amount);

        return "<p> In this last section you typed "+wordCount+" words and detected "+correct_amount+" out of "+targetAmount+" X's.</p>" +
        "<p> Keep it up! </p>"+
        "<p> Push the button whenever you are ready to continue</p>"
      }
      
      ,
      choices: ["CONTINUE"]
    }
    //conditional timeline to run rest
    var if_node = {
      timeline: [rest],
      conditional_function: function () {
        trial_counter++;
        if (trial_counter % 2 === 0) {
          return true;
        } else {
          return false;
        }
      }
    };

    //trial procedure where all timelines are combined
    var trial_procedure = {
      timeline: [experiment, if_node],
      timeline_variables: testVariables,
      randomize_order: true,
    };
    timeline.push(trial_procedure);

    //after experiment the user gets an overall debrief
    var debrief_block = {
      type: "html-keyboard-response",
      stimulus: function () {
        var totalData = jsPsych.data.get();

        var targetAmount = totalData.select('target').sum();
        var correctAmount = totalData.select('correctKeyPressed').values.toString();
        var correct_amount = (correctAmount.match(/56/g) || []).length

        var words = totalData.select('responses').values.toString();
        var wordsTotal = words.split(" ").length;

        return "<p>You detected "+correct_amount+" out of "+targetAmount+" X's in total!</p>" +
          "<p>You typed " + wordsTotal + " words in total!</p>" +
          "<p>Press any key to end the experiment. Thank you!</p>";
      }
    };
    timeline.push(debrief_block);

    //user gets code to tell MTurk that they completed the task
    var code = {
      type: "html-button-response",
      stimulus: "<p> <strong> Copy code: </strong>" + jsPsych.randomization.randomID(8) + "</p>",
      choices: ["FINISH"]
    };
    timeline.push(code);

    jsPsych.init({
      timeline: timeline,
      on_finish: function () { jsPsych.data.displayData() },
    })
  </script>
</body>

</html>